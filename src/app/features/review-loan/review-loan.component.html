<div class="review-loan-container">
  <div class="progress-bar-container">
    <ul class="progress-steps">
      <li
        [class.active]="currentSection >= 1"
        [class.completed]="currentSection > 1"
      >
        <div class="step-wrapper">
          <span class="step-number">
            {{ currentSection > 1 ? "✔" : "1" }}
          </span>
        </div>
        <span class="step-label">Identitas</span>
      </li>

      <!-- <li
        [class.active]="currentSection >= 2"
        [class.completed]="currentSection > 2"
      >
        <div class="step-wrapper">
          <span class="step-number">
            {{ currentSection > 2 ? "✔" : "2" }}
          </span>
        </div>
        <span class="step-label">Kontak</span>
      </li> -->

      <li
        [class.active]="currentSection >= 2"
        [class.completed]="currentSection > 2"
      >
        <div class="step-wrapper">
          <span class="step-number">
            {{ currentSection > 2 ? "✔" : "2" }}
          </span>
        </div>
        <span class="step-label">Capital & Pengajuan</span>
      </li>

      <li [class.active]="currentSection >= 3">
        <div class="step-wrapper">
          <span class="step-number">3</span>
        </div>
        <span class="step-label">Selesai</span>
      </li>
    </ul>
  </div>

  <form [formGroup]="loanForm" (ngSubmit)="submitForm()">
    <div *ngIf="currentSection === 1" class="container mt-4">
      <h3 class="mb-3">Informasi Identitas</h3>
      <div class="row g-4">
        <!-- Kiri: Preview Gambar KTP, Selfie KTP, dan Rumah -->
        <div class="col-md-5">
          <div class="card shadow-sm mb-3">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <span>Foto KTP</span>
              <button
                class="btn btn-sm btn-light"
                data-bs-toggle="modal"
                data-bs-target="#ktpModal"
              >
                Lihat Besar
              </button>
            </div>
            <div class="card-body text-center">
              <img
                [src]="
                  review_loan.customerDetails.ktpUrl ||
                  'assets/images/default-ktp.jpg'
                "
                alt="Foto KTP"
                class="img-fluid rounded shadow-sm"
                style="max-height: 300px; object-fit: cover; cursor: zoom-in"
                data-bs-toggle="modal"
                data-bs-target="#ktpModal"
              />
            </div>
          </div>

          <div class="card shadow-sm mb-3">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <span>Selfie + KTP</span>
              <button
                class="btn btn-sm btn-light"
                data-bs-toggle="modal"
                data-bs-target="#selfieKtpModal"
              >
                Lihat Besar
              </button>
            </div>
            <div class="card-body text-center">
              <img
                [src]="
                  review_loan.customerDetails.selfieKtpUrl ||
                  'assets/images/default-selfie.jpg'
                "
                alt="Selfie KTP"
                class="img-fluid rounded shadow-sm"
                style="max-height: 300px; object-fit: cover"
                style="max-height: 300px; object-fit: cover; cursor: zoom-in"
                data-bs-toggle="modal"
                data-bs-target="#selfieKtpModal"
              />
            </div>
          </div>

          <!-- Modal untuk Zoom KTP -->
          <app-image-modal
            modalId="ktpModal"
            [imageUrl]="
              review_loan.customerDetails.ktpUrl ||
              'assets/images/default-ktp.jpg'
            "
            title="Pratinjau KTP"
          >
          </app-image-modal>
          <app-image-modal
            modalId="selfieKtpModal"
            [imageUrl]="
              review_loan.customerDetails.selfieKtpUrl ||
              'assets/images/default-ktp.jpg'
            "
            title="Pratinjau KTP"
          >
          </app-image-modal>
        </div>

        <!-- Kanan: Data Identitas -->
        <div class="col-md-7">
          <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
              Data Inputan Nasabah
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Nama Lengkap</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="review_loan.customerDetails.user.name"
                  readonly
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Alamat Lengkap</label>
                <textarea class="form-control" rows="3" readonly
                  >{{ review_loan.customerDetails.street }}, {{
                    review_loan.customerDetails.district
                  }}, {{ review_loan.customerDetails.province }} {{
                    review_loan.customerDetails.postalCode
                  }}
            </textarea
                >
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">No KTP</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.nik"
                    readonly
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Tanggal Lahir</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.formattedTtl"
                    readonly
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Jenis Kelamin</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.gender"
                    readonly
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Nama Ibu Kandung</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.mothersName"
                    readonly
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">No. Telpon</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.noTelp"
                    readonly
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Email</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.user.email"
                    readonly
                  />
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">No. Rek</label>
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.noRek"
                    readonly
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="noteIdentity" class="form-label"
                  >Catatan Marketing</label
                >
                <textarea
                  class="form-control"
                  id="noteIdentity"
                  formControlName="noteIdentity"
                  rows="3"
                ></textarea>
              </div>

              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="nextSection()"
                >
                  Selanjutnya
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="currentSection === 2" class="container mt-4">
      <h3 class="mb-4">Informasi Capital & Pengajuan</h3>

      <!-- Summary Card untuk Quick Overview -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-calculator me-2"></i>Ringkasan Perhitungan
              </h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-3 mb-3">
                  <div class="border-end">
                    <h6 class="text-muted mb-1">Jumlah Pinjaman</h6>
                    <h4 class="text-primary mb-0">
                      {{ toRupiah(review_loan.loanRequest.amount) }}
                    </h4>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="border-end">
                    <h6 class="text-muted mb-1">Total Bunga</h6>
                    <h4 class="text-success mb-0">
                      {{ toRupiah(review_loan.loanRequest.interest!!) }}
                    </h4>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="border-end">
                    <h6 class="text-muted mb-1">Biaya Admin</h6>
                    <h4 class="text-warning mb-0">
                      {{ toRupiah(review_loan.loanRequest.adminFee!!) }}
                    </h4>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <h6 class="text-muted mb-1">
                    Total Pinjaman + Bunga + Admin Fee
                  </h6>
                  <h4 class="text-danger mb-0">
                    {{
                      toRupiah(
                        review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!
                      )
                    }}
                  </h4>
                </div>
              </div>

              <!-- Perhitungan Cicilan -->
              <div class="row mt-3 pt-3 border-top">
                <div class="col-md-6">
                  <div class="bg-light p-3 rounded">
                    <h6 class="text-white mb-2">Cicilan per Bulan</h6>
                    <h3 class="text-primary mb-0">
                      {{
                        toRupiah(
                          (review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor
                        )
                      }}
                    </h3>
                    <small class="text-white"
                      >untuk {{ review_loan.loanRequest.tenor }} bulan</small
                    >
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="bg-light p-3 rounded">
                    <h6 class="text-white mb-2">Rasio Cicilan vs Gaji</h6>
                    <h3
                      class="mb-0"
                      [ngClass]="{
                        'text-success':
                          ((review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor /
                            review_loan.customerDetails.salary) *
                            100 <=
                          30,
                        'text-warning':
                          ((review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor /
                            review_loan.customerDetails.salary) *
                            100 >
                            30 &&
                          ((review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor /
                            review_loan.customerDetails.salary) *
                            100 <=
                            50,
                        'text-danger':
                          ((review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor /
                            review_loan.customerDetails.salary) *
                            100 >
                          50
                      }"
                    >
                      {{
                        (
                          ((review_loan.loanRequest.amount +
                            review_loan.loanRequest.interest!!) /
                            review_loan.loanRequest.tenor /
                            review_loan.customerDetails.salary) *
                          100
                        ).toFixed(1)
                      }}%
                    </h3>
                    <small class="text-white">dari penghasilan</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Informasi Customer Capital -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">
                <i class="fas fa-user-tie me-2"></i>Profil Customer
              </h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Penghasilan Bulanan</label
                >
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control fw-bold"
                    [value]="toRupiah(review_loan.customerDetails.salary)"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Status Pekerjaan</label
                >
                <input
                  type="text"
                  class="form-control"
                  [value]="review_loan.customerDetails.job"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Plafond Tersedia</label
                >
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.customerDetails.availablePlafond"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-0">
                <label class="form-label fw-bold text-muted"
                  >Kategori Plafond</label
                >
                <input
                  type="text"
                  class="form-control"
                  [value]="review_loan.customerDetails.plafond.plan"
                  readonly
                />
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-header bg-secondary text-white">
              <h6 class="mb-0">
                <i class="fas fa-file-invoice-dollar me-2"></i>Detail Pengajuan
              </h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Jumlah Pinjaman</label
                >
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control fw-bold text-primary"
                    [value]="toRupiah(review_loan.loanRequest.amount)"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Tenor Pinjaman</label
                >
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    [value]="review_loan.loanRequest.tenor"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold text-muted"
                  >Tujuan Penggunaan</label
                >
                <textarea
                  class="form-control"
                  rows="2"
                  [value]="
                    review_loan.loanRequest.purpose || 'Tidak disebutkan'
                  "
                  readonly
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analisis Kelayakan -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div
              class="card-header"
              [ngClass]="{
                'bg-success text-white':
                  ((review_loan.loanRequest.amount +
                    review_loan.loanRequest.interest!!) /
                    review_loan.loanRequest.tenor /
                    review_loan.customerDetails.salary) *
                    100 <=
                  30,
                'bg-warning text-dark':
                  ((review_loan.loanRequest.amount +
                    review_loan.loanRequest.interest!!) /
                    review_loan.loanRequest.tenor /
                    review_loan.customerDetails.salary) *
                    100 >
                    30 &&
                  ((review_loan.loanRequest.amount +
                    review_loan.loanRequest.interest!!) /
                    review_loan.loanRequest.tenor /
                    review_loan.customerDetails.salary) *
                    100 <=
                    50,
                'bg-danger text-white':
                  ((review_loan.loanRequest.amount +
                    review_loan.loanRequest.interest!!) /
                    review_loan.loanRequest.tenor /
                    review_loan.customerDetails.salary) *
                    100 >
                  50
              }"
            >
              <h6 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Analisis Kelayakan Kredit
                <span
                  class="badge bg-light text-dark ms-2"
                  *ngIf="
                    ((review_loan.loanRequest.amount +
                      review_loan.loanRequest.interest!!) /
                      review_loan.loanRequest.tenor /
                      review_loan.customerDetails.salary) *
                      100 <=
                    30
                  "
                  >LAYAK</span
                >
                <span
                  class="badge bg-warning text-dark ms-2"
                  *ngIf="
                    ((review_loan.loanRequest.amount +
                      review_loan.loanRequest.interest!!) /
                      review_loan.loanRequest.tenor /
                      review_loan.customerDetails.salary) *
                      100 >
                      30 &&
                    ((review_loan.loanRequest.amount +
                      review_loan.loanRequest.interest!!) /
                      review_loan.loanRequest.tenor /
                      review_loan.customerDetails.salary) *
                      100 <=
                      50
                  "
                  >PERLU REVIEW</span
                >
                <span
                  class="badge bg-danger ms-2"
                  *ngIf="
                    ((review_loan.loanRequest.amount +
                      review_loan.loanRequest.interest!!) /
                      review_loan.loanRequest.tenor /
                      review_loan.customerDetails.salary) *
                      100 >
                    50
                  "
                  >BERISIKO TINGGI</span
                >
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <i class="fas fa-percentage fa-2x text-muted"></i>
                  </div>
                  <h6 class="text-muted">Debt to Income Ratio</h6>
                  <h4
                    [ngClass]="{
                      'text-success':
                        ((review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!!) /
                          review_loan.loanRequest.tenor /
                          review_loan.customerDetails.salary) *
                          100 <=
                        30,
                      'text-warning':
                        ((review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!!) /
                          review_loan.loanRequest.tenor /
                          review_loan.customerDetails.salary) *
                          100 >
                          30 &&
                        ((review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!!) /
                          review_loan.loanRequest.tenor /
                          review_loan.customerDetails.salary) *
                          100 <=
                          50,
                      'text-danger':
                        ((review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!!) /
                          review_loan.loanRequest.tenor /
                          review_loan.customerDetails.salary) *
                          100 >
                        50
                    }"
                  >
                    {{
                      (
                        ((review_loan.loanRequest.amount +
                          review_loan.loanRequest.interest!!) /
                          review_loan.loanRequest.tenor /
                          review_loan.customerDetails.salary) *
                        100
                      ).toFixed(1)
                    }}%
                  </h4>
                  <small class="text-muted"
                    >Standar: ≤30% (Baik), 30-50% (Hati-hati), >50%
                    (Berisiko)</small
                  >
                </div>
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <i class="fas fa-credit-card fa-2x text-muted"></i>
                  </div>
                  <h6 class="text-muted">Utilisasi Plafond</h6>
                  <h4
                    [ngClass]="{
                      'text-success':
                        ((review_loan.loanRequest.amount!! +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!) /
                          fromRupiah(
                            review_loan.customerDetails.availablePlafond
                          )) *
                          100 <=
                        70,
                      'text-warning':
                        ((review_loan.loanRequest.amount!! +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!) /
                          fromRupiah(
                            review_loan.customerDetails.availablePlafond
                          )) *
                          100 >
                          70 &&
                        ((review_loan.loanRequest.amount!! +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!) /
                          fromRupiah(
                            review_loan.customerDetails.availablePlafond
                          )) *
                          100 <=
                          90,
                      'text-danger':
                        ((review_loan.loanRequest.amount!! +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!) /
                          fromRupiah(
                            review_loan.customerDetails.availablePlafond
                          )) *
                          100 >
                        90
                    }"
                  >
                    {{
                      (
                        ((review_loan.loanRequest.amount!! +
                          review_loan.loanRequest.interest!! +
                          review_loan.loanRequest.adminFee!!) /
                          fromRupiah(
                            review_loan.customerDetails.availablePlafond
                          )) *
                        100
                      ).toFixed(1)
                    }}%
                  </h4>
                  <small class="text-muted">dari plafond tersedia</small>
                </div>
                <div class="col-md-4 text-center">
                  <div class="mb-2">
                    <i class="fas fa-calendar-alt fa-2x text-muted"></i>
                  </div>
                  <h6 class="text-muted">Tenor Pinjaman</h6>
                  <h4 class="text-info">
                    {{ review_loan.loanRequest.tenor }} Bulan
                  </h4>
                  <small class="text-muted">periode pembayaran</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Foto Rumah -->
      <div class="card shadow-sm mb-4">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <span>Foto Rumah</span>
          <button
            class="btn btn-sm btn-light"
            data-bs-toggle="modal"
            data-bs-target="#fotoRumahModal"
          >
            Lihat Besar
          </button>
        </div>
        <div class="card-body text-center">
          <img
            [src]="
              review_loan.customerDetails.houseUrl ||
              'assets/images/default-house.jpg'
            "
            alt="Foto Rumah"
            class="img-fluid rounded shadow-sm"
            style="max-height: 300px; object-fit: cover; cursor: pointer"
            data-bs-toggle="modal"
            data-bs-target="#fotoRumahModal"
          />
        </div>
        <app-image-modal
          modalId="fotoRumahModal"
          [imageUrl]="
            review_loan.customerDetails.houseUrl ||
            'assets/images/default-ktp.jpg'
          "
          title="Pratinjau Rumah"
        >
        </app-image-modal>
      </div>

      <!-- Catatan Marketing -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0">
            <i class="fas fa-sticky-note me-2"></i>Catatan Marketing
          </h6>
        </div>
        <div class="card-body">
          <textarea
            class="form-control"
            rows="4"
            formControlName="noteCapital"
          ></textarea>
        </div>
      </div>

      <!-- Navigasi -->
      <div class="form-navigation d-flex justify-content-between">
        <button
          type="button"
          class="btn btn-outline-secondary btn-lg"
          (click)="prevSection()"
        >
          <i class="fas fa-arrow-left me-2"></i>Sebelumnya
        </button>
        <button
          type="button"
          class="btn btn-primary btn-lg"
          (click)="nextSection()"
        >
          Selanjutnya<i class="fas fa-arrow-right ms-2"></i>
        </button>
      </div>
    </div>
    <div *ngIf="currentSection === 3" class="container mt-4">
      <h3 class="mb-3">Ringkasan Pengajuan</h3>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">Identitas</div>
        <div class="card-body row">
          <div class="col-md-6 mb-2">
            <label class="fw-bold">Nama Lengkap:</label>
            <p>{{ loanForm.get("namaLengkap")?.value || "-" }}</p>
          </div>
          <div class="col-md-6 mb-2">
            <label class="fw-bold">Alamat:</label>
            <p>{{ loanForm.get("alamat")?.value || "-" }}</p>
          </div>
          <div class="col-md-6 mb-2">
            <label class="fw-bold">Note Identity:</label>
            <p>{{ loanForm.get("noteIdentity")?.value || "-" }}</p>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">Capital & Pengajuan</div>
        <div class="card-body row">
          <div class="col-md-4 mb-2">
            <label class="fw-bold">Jumlah Pinjaman:</label>
            <p class="text-danger fw-semibold">
              {{ loanForm.get("jumlahPinjaman")?.value || "Rp0" }}
            </p>
          </div>
          <div class="col-md-4 mb-2">
            <label class="fw-bold">Sisa Plafond:</label>
            <p>{{ loanForm.get("sisaPlafond")?.value || "Rp0" }}</p>
          </div>
          <div class="col-md-4 mb-2">
            <label class="fw-bold">Tenor:</label>
            <p>{{ loanForm.get("tenor")?.value || "0" }} bulan</p>
          </div>
          <div class="col-md-12 mb-2">
            <label class="fw-bold">Note Capital:</label>
            <p>{{ loanForm.get("noteCapital")?.value || "-" }}</p>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-4">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="prevSection()"
        >
          <i class="bi bi-arrow-left-circle"></i> Sebelumnya
        </button>

        <div class="d-flex gap-2">
          <button
            type="button"
            class="btn btn-outline-danger"
            (click)="rejectLoan()"
          >
            <i class="bi bi-x-circle-fill"></i> Tolak
          </button>
          <button
            type="button"
            class="btn btn-outline-success"
            (click)="recommendLoan()"
          >
            <i class="bi bi-check-circle-fill"></i> Rekomendasikan
          </button>
        </div>
      </div>
    </div>
  </form>
</div>
